{% extends "base.html" %}

{% block title %}Resource Inventory - DASH{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h2 class="mb-2">
                        <i class="fas fa-box me-2"></i>Resource Inventory Management
                    </h2>
                    <p class="mb-0">Track and manage emergency supplies and resources</p>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.user_type in ['admin', 'rescue_team'] %}
    <div class="row mb-4">
        <div class="col-12 text-end">
            <button class="btn btn-primary" onclick="openAddResourceModal()">
                <i class="fas fa-plus me-2"></i>Add Resource
            </button>
        </div>
    </div>
    {% endif %}

    {% if low_stock %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alerts</h5>
                <ul class="mb-0">
                    {% for resource in low_stock %}
                    <li>{{ resource.resource_name }}: Only {{ resource.quantity_available }} {{ resource.unit }} remaining</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Resource Inventory</h5>
                </div>
                <div class="card-body">
                    {% if resources %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Resource</th>
                                        <th>Type</th>
                                        <th>Available</th>
                                        <th>Total</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        {% if current_user.user_type in ['admin', 'rescue_team'] %}
                                        <th>Actions</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for resource in resources %}
                                    <tr class="{% if resource.quantity_available <= resource.low_stock_threshold %}table-warning{% endif %}">
                                        <td><strong>{{ resource.resource_name }}</strong></td>
                                        <td><span class="badge bg-primary">{{ resource.resource_type }}</span></td>
                                        <td>{{ resource.quantity_available }} {{ resource.unit }}</td>
                                        <td>{{ resource.quantity_total }} {{ resource.unit }}</td>
                                        <td>{{ resource.location_name or 'N/A' }}</td>
                                        <td>
                                            {% if resource.quantity_available <= resource.low_stock_threshold %}
                                            <span class="badge bg-warning">Low Stock</span>
                                            {% elif resource.quantity_available == 0 %}
                                            <span class="badge bg-danger">Out of Stock</span>
                                            {% else %}
                                            <span class="badge bg-success">Available</span>
                                            {% endif %}
                                        </td>
                                        {% if current_user.user_type in ['admin', 'rescue_team'] %}
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="distributeResource({{ resource.id }})">
                                                <i class="fas fa-share"></i>
                                            </button>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No resources in inventory</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="addResourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <div class="mb-3">
                        <label class="form-label">Resource Name</label>
                        <input type="text" class="form-control" id="resourceName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Resource Type</label>
                        <select class="form-select" id="resourceType" required>
                            <option value="">Select</option>
                            <option value="food">Food</option>
                            <option value="medical">Medical Supplies</option>
                            <option value="blankets">Blankets</option>
                            <option value="water">Water</option>
                            <option value="shelter">Shelter Materials</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Total Quantity</label>
                            <input type="number" class="form-control" id="quantityTotal" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit</label>
                            <input type="text" class="form-control" id="unit" value="units" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location Name</label>
                        <input type="text" class="form-control" id="locationName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Low Stock Threshold</label>
                        <input type="number" class="form-control" id="lowStockThreshold" value="10">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitResource()">Add Resource</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function openAddResourceModal() {
        new bootstrap.Modal(document.getElementById('addResourceModal')).show();
    }

    function submitResource() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const data = {
                    resource_name: document.getElementById('resourceName').value,
                    resource_type: document.getElementById('resourceType').value,
                    quantity_total: parseInt(document.getElementById('quantityTotal').value),
                    quantity_available: parseInt(document.getElementById('quantityTotal').value),
                    location_name: document.getElementById('locationName').value,
                    low_stock_threshold: parseInt(document.getElementById('lowStockThreshold').value),
                    unit: document.getElementById('unit').value,
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                fetch('/api/resource_inventory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Resource added successfully!');
                        location.reload();
                    }
                });
            });
        }
    }

    function distributeResource(resourceId) {
        const quantity = prompt('Enter quantity to distribute:');
        if (quantity) {
            const distributedTo = prompt('Enter recipient/location:');
            if (distributedTo) {
                fetch('/api/resource_inventory/distribute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        resource_id: resourceId,
                        quantity: parseInt(quantity),
                        distributed_to: distributedTo
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Resource distributed successfully!');
                        location.reload();
                    }
                });
            }
        }
    }
</script>
{% endblock %}

